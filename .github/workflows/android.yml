name: crott

on:
  # Pemicu manual agar bisa dijalankan dari UI GitHub
  workflow_dispatch:

permissions:
  # 'write' diperlukan untuk menyimpan cache
  contents: write 

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest
    env:
      TAILSCALE_AUTHKEY: ${{ vars.AUTHKEY }}
      USERNAME: runner
      PASSWORD: runner
      TAILSCALE_HOSTNAME: gh-vnc-${{ github.run_id }}
      VNC_DISPLAY: ":1"
      VNC_PORT: 5901
      NOVNC_PORT: 6080
      CACHE_KEY_VERSION: v2 # Versi Kustom Cache

    steps:
      - uses: actions/checkout@v4

      # ===============================================
      # 1. CACHING APT PACKAGES (Restore)
      # ===============================================
      - name: ðŸ“¦ 1. Restore APT Cache (Paket Instalasi)
        id: cache-apt-restore
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ env.CACHE_KEY_VERSION }} 

      # ðŸ”¥ FIX CACHING: Clean up APT Cache Locks ðŸ”¥
      # Dijalankan SELALU untuk memastikan tidak ada file lock yang tersisa dari cache sebelumnya.
      - name: Clean up apt cache
        if: always()
        run: |
          echo "Menghapus lock dan partial files APT..."
          sudo rm -f /var/cache/apt/archives/lock
          sudo rm -f /var/lib/apt/lists/lock
          sudo rm -rf /var/cache/apt/archives/partial
          sudo rm -rf /var/lib/apt/lists/partial
          
      # ðŸ”¥ FIX CACHING: Grant Permissions to APT cache ðŸ”¥
      # Mengubah kepemilikan APT cache agar user '$USERNAME' dapat menggunakannya.
      - name: Grant permissions to APT cache
        if: always()
        run: |
          echo "Mengubah kepemilikan APT cache ke user $USERNAME..."
          # Menggunakan $USERNAME dari env: untuk konsistensi.
          sudo chown -R $USERNAME:$USERNAME /var/cache/apt
          sudo chown -R $USERNAME:$USERNAME /var/lib/apt

      # ===============================================
      # 2. CACHING USER DATA (Restore)
      # ===============================================
      - name: â™»ï¸ 2. Restore User Data Cache (Home: /home/runner)
        id: cache-user-restore
        uses: actions/cache@v4
        with:
          path: /home/${{ env.USERNAME }}
          key: ${{ runner.os }}-xfce-data-${{ env.CACHE_KEY_VERSION }}
          restore-keys: |
            ${{ runner.os }}-xfce-data-

      # 3. KONFIGURASI USER & SUDO
      - name: Configure User (Runner)
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME}

      # 4. INSTALASI XFCE, VNC, & NOVNC
      - name: ðŸ’» Install Xfce, VNC, noVNC, and Setup
        run: |
          echo ">>> Installing Desktop, VNC, and Dependencies..."
          sudo apt update -qq
          sudo apt install -y -qq \
            xfce4 xfce4-goodies \
            tigervnc-standalone-server \
            dbus-x11 \
            python3-pip git net-tools \
            > /dev/null 2>&1
          
          # Instalasi noVNC
          sudo git clone https://github.com/novnc/noVNC.git /opt/noVNC
          sudo git clone https://github.com/novnc/websockify /opt/noVNC/utils/websockify
          sudo pip3 install websockify
          
          # Konfigurasi VNC xstartup
          echo "Membuat konfigurasi VNC untuk user $USERNAME..."
          sudo mkdir -p /home/${USERNAME}/.vnc
          
          VNC_XSTARTUP='#!/bin/bash
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          startxfce4 &'
          
          echo "$VNC_XSTARTUP" | sudo tee /home/${USERNAME}/.vnc/xstartup
          sudo chmod +x /home/${USERNAME}/.vnc/xstartup
          
          # Set VNC password
          echo "${PASSWORD}" | vncpasswd -f | sudo tee /home/${USERNAME}/.vnc/passwd
          
          # Atur kepemilikan
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}/.vnc
          sudo chmod 600 /home/${USERNAME}/.vnc/passwd
          
          # Bersihkan cache apt setelah instalasi selesai
          sudo apt clean

      # 5. SAVE APT CACHE
      - name: ðŸ’¾ Save APT Cache
        uses: actions/cache@v4
        # Hanya simpan jika instalasi paket di langkah 4 berhasil
        if: success()
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ env.CACHE_KEY_VERSION }}

      # 6. INSTALASI DAN START TAILSCALE
      - name: Install and Start Tailscale
        run: |
          echo ">>> Installing and Starting Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sudo sh >/dev/null 2>&1
          sudo tailscale up --authkey "${TAILSCALE_AUTHKEY}" --hostname "${TAILSCALE_HOSTNAME}" --accept-routes --ssh
          sleep 5
          sudo tailscale ip -4

      # 7. START VNC SERVER DAN NOVNC
      - name: ðŸš€ Start VNC Server and noVNC
        run: |
          echo ">>> Memulai VNC Server dan noVNC..."
          
          # Start VNC Server sebagai user runner
          sudo su - ${USERNAME} -c "/usr/bin/vncserver ${VNC_DISPLAY} -geometry 1280x800 -depth 24"
          
          # Start websockify (noVNC) sebagai user runner
          sudo su - ${USERNAME} -c "/opt/noVNC/utils/websockify/run --web /opt/noVNC ${NOVNC_PORT} localhost:${VNC_PORT} &"

          sleep 5
          
      # 8. KONEKSI & KEEP ALIVE
      - name: Connection + Keep Alive
        run: |
          IP_ADDR=$(sudo tailscale ip -4)
          echo "::notice file=README.md,line=1::=== FINAL CONNECTION INFO ==="
          echo "::notice file=README.md,line=1::Desktop: Xfce4 (VNC/noVNC)"
          echo "::notice file=README.md,line=1::USERNAME: ${USERNAME}"
          echo "::notice file=README.md,line=1::PASSWORD: ${PASSWORD}"
          echo "::notice file=README.md,line=1::Tailscale IP: ${IP_ADDR}"
          echo "::notice file=README.md,line=1::Akses Web VNC (dari Tailnet Anda): http://${IP_ADDR}:${NOVNC_PORT}/vnc.html"
          
          echo ">>> Keeping runner alive for VNC session."
          # Menahan job selama 600 detik (10 menit). Anda harus membatalkan job ini secara manual.
          while true; do sleep 600; done

      # 9. SAVE USER DATA (Wajib di Akhir, Walau Job Gagal/Dibatalkan)
      - name: ðŸ’¾ Save User Data Cache (Wajib)
        uses: actions/cache@v4
        # Menggunakan 'always()' untuk memastikan data tersimpan walaupun sesi dibatalkan
        if: always()
        with:
          path: /home/${{ env.USERNAME }}
          key: ${{ runner.os }}-xfce-data-${{ env.CACHE_KEY_VERSION }}
